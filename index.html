<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Senarai Perkhidmatan Penduduk Banjaria Court</title>

  <!-- Google Font (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            page: '#F6F7F3',
            panel: '#EEF0EA',
            accent: '#7EC49D',
            'accent-strong': '#0E7C4B',
            ink: '#0F172A',
            muted: '#6B7280'
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui']
          },
          boxShadow: {
            card: '0 15px 40px rgba(0,0,0,0.06)'
          }
        }
      }
    }
  </script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css">
  
</head>
<body class="min-h-screen bg-page text-ink antialiased">
  <div class="relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-accent/25 via-white to-panel/60"></div>

    <header class="relative">
      <div class="max-w-5xl mx-auto px-4 pt-10 pb-6">
        <div class="flex flex-col gap-4">
          <div class="inline-flex items-center gap-2 self-start bg-white/70 backdrop-blur px-3 py-1 rounded-full border border-white/60 text-xs font-semibold text-accent-strong shadow-sm">
            ğŸŒ± Direktori komuniti Banjaria Court
          </div>
          <div class="space-y-3">
            <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-ink">Senarai Perkhidmatan Penduduk Banjaria Court</h1>
            <p class="text-base text-slate-700 max-w-2xl leading-relaxed">Rujuk kepakaran jiran terdekatâ€”pantau status terkini, cari mengikut bidang, dan kongsi kad terus ke WhatsApp.</p>
          </div>
          <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
            <a href="https://forms.gle/BsTZ2z81Q4XR8zHw6" target="_blank" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-ink text-white font-semibold shadow-sm hover:shadow-md transition">
              ğŸ“ Daftar Perkhidmatan
            </a>
            <a id="shareLink" href="#" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-accent text-ink font-semibold shadow-sm hover:bg-accent-strong/90 hover:text-white transition">
              ğŸ”— Kongsi via WhatsApp
            </a>
            <button id="copyLink" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-white border border-slate-200 text-ink font-semibold shadow-sm hover:bg-slate-50 transition">
              ğŸ“‹ Salin pautan
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="relative max-w-5xl mx-auto px-4 pb-12">
      <section class="bg-white/80 backdrop-blur border border-white/60 rounded-2xl shadow-card p-5 sm:p-6 -mt-4 mb-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center">
          <div class="sm:col-span-2">
            <div class="text-sm font-semibold text-slate-700">Jumlah Perkhidmatan Berdaftar</div>
            <div id="jumlahPerkhidmatan" class="mt-1 text-3xl font-extrabold text-ink">â€”</div>
            <div class="text-sm text-muted">Data dikemas kini terus dari borang komuniti.</div>
          </div>
          <div class="sm:justify-self-end">
            <div class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-panel text-slate-700 text-sm border border-white/80">
              âœ… Tapisan automatik rekod lulus
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white border border-slate-100 rounded-2xl shadow-card p-4 sm:p-5 mb-8">
        <div class="flex flex-col gap-3">
          <div class="flex flex-col md:flex-row gap-3 md:items-center">
            <div class="flex-1 flex items-center gap-2 bg-slate-50 rounded-lg border border-slate-200 px-3 py-2">
              <label for="searchInput" class="sr-only">Cari perkhidmatan</label>
              <span class="text-lg">ğŸ”</span>
              <input id="searchInput" type="search" class="flex-1 bg-transparent focus:outline-none" placeholder="Cari nama, syarikat, telefon, bidang, atau butiran..." />
              <button id="clearSearch" class="text-sm text-muted hover:text-ink">Kosong</button>
            </div>
            <div class="flex items-center gap-2 text-sm text-muted">
              <span id="searchCount">0 keputusan</span>
            </div>
          </div>

          <div class="flex flex-col lg:flex-row gap-3 lg:items-center">
            <div class="flex items-center gap-2">
              <label for="bidangSelect" class="text-sm text-muted">Bidang:</label>
              <select id="bidangSelect" class="w-56 bg-white border border-slate-200 text-ink p-2 rounded-md shadow-sm">
                <option value="Semua">Semua</option>
              </select>
            </div>
            <div id="chipFilters" class="flex flex-wrap gap-2 text-sm"></div>
            <div class="lg:ml-auto flex gap-2">
              <button id="resetFilters" class="px-3 py-2 text-sm bg-slate-50 border border-slate-200 rounded-md hover:bg-slate-100">Set semula tapis</button>
            </div>
          </div>
        </div>
      </section>

      <section class="mb-10">
        <div id="directory" class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
        <div id="loadingState" class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
        <div id="errorState" class="hidden"></div>
        <div id="emptyState" class="hidden"></div>
      </section>

      <section class="bg-panel border border-slate-100 rounded-2xl p-5 text-sm text-slate-700 shadow-sm">
        <div class="font-semibold text-ink mb-1">Tentang direktori ini</div>
        <p>Direktori ini dikumpul daripada borang komuniti. Hanya rekod berstatus lulus dipaparkan. Guna carian dan tapis bidang untuk jumpa kepakaran yang tepat, atau kongsi kad terus ke WhatsApp.</p>
      </section>
    </main>
  </div>

  <script>
    function escapeHTML(str){
      if(!str) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function normalizeText(s){ return (s || '').toString().toLowerCase(); }

    function escapeRegex(str){
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightHTML(text, query){
      if(!query) return escapeHTML(text);
      try {
        const q = escapeRegex(query);
        const re = new RegExp(`(${q})`, 'ig');
        return escapeHTML(text).replace(re, '<mark class="bg-yellow-200 text-ink rounded-sm px-0.5">$1</mark>');
      } catch(e) {
        return escapeHTML(text);
      }
    }

    let searchIndex = [];
    let allCards = [];
    let bidangSet = new Set();
    let isLoading = true;

    function buildSearchIndex(cards){
      searchIndex = cards.map(c => {
        const f = c.fields || {};
        const blob = [
          f.nama, f.company, f.telefon, f.bidang, f.subbidang, f.butiran
        ].map(x => normalizeText(x)).join(' | ');
        return { card: c, blob };
      });
      updateSearchCount(cards.length);
    }

    function initSearchIndex(){
      buildSearchIndex(allCards);
    }

    function showSkeleton(count = 6){
      const wrap = document.getElementById('loadingState');
      const dir = document.getElementById('directory');
      wrap.innerHTML = '';
      dir.innerHTML = '';
      const card = `
        <div class="animate-pulse bg-white border border-slate-100 rounded-xl p-4 shadow-sm space-y-3">
          <div class="h-3 w-1/3 bg-slate-200 rounded"></div>
          <div class="h-4 w-2/3 bg-slate-200 rounded"></div>
          <div class="h-3 w-1/2 bg-slate-200 rounded"></div>
          <div class="h-20 w-full bg-slate-100 rounded"></div>
          <div class="flex gap-2">
            <div class="h-9 w-24 bg-slate-200 rounded"></div>
            <div class="h-9 w-28 bg-slate-200 rounded"></div>
          </div>
        </div>`;
      for(let i=0;i<count;i++){
        const div = document.createElement('div');
        div.innerHTML = card;
        wrap.appendChild(div.firstElementChild);
      }
    }

    function hideSkeleton(){
      const wrap = document.getElementById('loadingState');
      if (wrap) wrap.innerHTML = '';
    }

    function renderEmptyState(show, reason){
      const el = document.getElementById('emptyState');
      el.classList.toggle('hidden', !show);
      el.innerHTML = show ? `
        <div class="col-span-full bg-white border border-slate-100 rounded-xl p-6 text-center shadow-sm">
          <div class="text-lg font-semibold text-ink mb-1">Tiada perkhidmatan ditemui</div>
          <div class="text-sm text-muted mb-3">${escapeHTML(reason || 'Cuba ubah carian atau tapis bidang.')}</div>
          <button id="emptyReset" class="px-3 py-2 rounded-md bg-slate-50 border border-slate-200 text-sm">Kosongkan carian</button>
        </div>` : '';
      if (show) {
        const btn = document.getElementById('emptyReset');
        if (btn) btn.onclick = () => {
          const input = document.getElementById('searchInput');
          if (input) input.value = '';
          const bidangSelect = document.getElementById('bidangSelect');
          if (bidangSelect) bidangSelect.value = 'Semua';
          performSearch('', 'Semua');
        };
      }
    }

    function renderErrorState(err){
      const el = document.getElementById('errorState');
      el.classList.remove('hidden');
      el.innerHTML = `
        <div class="col-span-full bg-white border border-red-100 rounded-xl p-6 text-center shadow-sm">
          <div class="text-lg font-semibold text-red-700 mb-1">Gagal memuat data</div>
          <div class="text-sm text-muted mb-3">${escapeHTML(err?.message || 'Sila cuba lagi sebentar.')}</div>
          <button id="retryFetch" class="px-3 py-2 rounded-md bg-red-50 border border-red-200 text-sm">Cuba semula</button>
        </div>`;
      const btn = document.getElementById('retryFetch');
      if (btn) btn.onclick = () => window.location.reload();
    }

    function performSearch(query, bidangFilter){
      const q = normalizeText(query).trim();
      const dir = document.getElementById('directory');
      dir.innerHTML = '';
      const results = searchIndex.filter(item => {
        if (bidangFilter && bidangFilter !== 'Semua') {
          const cardBidang = normalizeText(item.card.fields.bidang || '');
          if (cardBidang !== bidangFilter.toLowerCase()) return false;
        }
        if (!q) return true;
        return item.blob.indexOf(q) !== -1;
      }).map(i => i.card);

      if (!results.length) {
        renderEmptyState(true, 'Tiada padanan untuk carian atau tapis semasa.');
        updateSearchCount(0);
        return;
      }

      renderEmptyState(false);

      results.forEach(c => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = c.html;
        if (q) {
          const walker = document.createTreeWalker(wrapper, NodeFilter.SHOW_TEXT, null, false);
          const nodes = [];
          while(walker.nextNode()) nodes.push(walker.currentNode);
          nodes.forEach(tnode => {
            const parent = tnode.parentNode;
            if (!parent) return;
            const newHTML = highlightHTML(tnode.textContent, q);
            if (newHTML !== escapeHTML(tnode.textContent)) {
              const span = document.createElement('span');
              span.innerHTML = newHTML;
              parent.replaceChild(span, tnode);
            }
          });
        }
        dir.appendChild(wrapper.firstElementChild);
      });

      updateSearchCount(results.length);
    }

    function updateSearchCount(n){
      const el = document.getElementById('searchCount');
      if (!el) return;
      el.textContent = `${n} keputusan`;
    }

    function debounce(fn, wait){
      let t;
      return function(...args){
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    function renderCards(filterBidang) {
      const dir = document.getElementById('directory');
      dir.innerHTML = '';
      const list = filterBidang === 'Semua'
        ? allCards
        : allCards.filter(c => (c.bidang || '').toLowerCase() === (filterBidang || '').toLowerCase());

      if (!list.length) {
        renderEmptyState(true, 'Tiada perkhidmatan ditemui untuk pilihan ini.');
        return;
      }

      renderEmptyState(false);

      list.forEach(c => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = c.html;
        dir.appendChild(wrapper.firstElementChild);
      });
    }

    function populateChips(){
      const chipWrap = document.getElementById('chipFilters');
      if (!chipWrap) return;
      chipWrap.innerHTML = '';
      const bidangArr = [...bidangSet].sort().slice(0, 6);
      bidangArr.forEach(b => {
        const btn = document.createElement('button');
        btn.className = 'px-3 py-1.5 rounded-full border border-slate-200 bg-slate-50 text-ink hover:bg-accent/20 text-sm';
        btn.textContent = b;
        btn.onclick = () => {
          const sel = document.getElementById('bidangSelect');
          if (sel) sel.value = b;
          const input = document.getElementById('searchInput');
          const q = input ? input.value : '';
          performSearch(q, b);
        };
        chipWrap.appendChild(btn);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearch');
      const bidangSelect = document.getElementById('bidangSelect');
      const resetFilters = document.getElementById('resetFilters');
      const copyLink = document.getElementById('copyLink');

      showSkeleton(6);

      const doSearch = () => {
        const bidangVal = bidangSelect ? bidangSelect.value : 'Semua';
        performSearch(input.value, bidangVal);
      };

      const debouncedSearch = debounce(doSearch, 200);
      if (input) input.addEventListener('input', debouncedSearch);
      if (bidangSelect) bidangSelect.addEventListener('change', debouncedSearch);

      if (clearBtn) clearBtn.addEventListener('click', () => {
        if (!input) return;
        input.value = '';
        input.focus();
        debouncedSearch();
      });

      if (resetFilters) resetFilters.addEventListener('click', () => {
        if (input) input.value = '';
        if (bidangSelect) bidangSelect.value = 'Semua';
        performSearch('', 'Semua');
      });

      if (input) {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') { input.value = ''; debouncedSearch(); }
          if (e.key === 'Enter') {
            const firstAnchor = document.querySelector('#directory a');
            if (firstAnchor) firstAnchor.focus();
          }
        });
      }

      if (copyLink) {
        copyLink.addEventListener('click', async () => {
          const url = window.location.href;
          try {
            await navigator.clipboard.writeText(url);
            copyLink.textContent = 'âœ”ï¸ Pautan disalin';
            setTimeout(() => copyLink.textContent = 'ğŸ“‹ Salin pautan', 1500);
          } catch(e) {
            copyLink.textContent = 'Salin gagal';
            setTimeout(() => copyLink.textContent = 'ğŸ“‹ Salin pautan', 1500);
          }
        });
      }

      // Statistik CSV URL (anda sudah publish CSV)
      const statistikUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaIC8vSqefzEVD6ndgQecCNLOb-mNdCtUZMAC_ojDvgDD-mCAnPBVgdLfYlUW7ehK73e8-1KIl4AKZ/pub?gid=2034381075&single=true&output=csv";

      fetch(statistikUrl)
        .then(r => { if(!r.ok) throw new Error('Gagal muat statistik'); return r.text(); })
        .then(csvText => {
          const lines = csvText.trim().split(/\r?\n/);
          function extractFromLine(line) {
            const cols = line.split(',');
            return cols.length > 1 ? cols[1].trim() : '';
          }
          let value = extractFromLine(lines[0]);
          if (!value && lines.length > 1) value = extractFromLine(lines[1]);
          if (!value) {
            const found = csvText.match(/,?\s*(\d{1,})\s*(?:,|\r?\n|$)/);
            value = found ? found[1] : '0';
          }
          document.getElementById('jumlahPerkhidmatan').textContent = value || '0';
        })
        .catch(err => {
          console.warn(err);
          document.getElementById('jumlahPerkhidmatan').textContent = '0';
        });

      const dataUrl = "https://script.google.com/macros/s/AKfycbyIDMuRP2Ozt_lx4V_wWYEwPmk3zIhr5LjxFAUzsrdv6E2fiVjEFpLhXmmYh84IzE5ROA/exec";

      fetch(dataUrl)
        .then(r => {
          if (!r.ok) throw new Error('Gagal dapatkan data');
          return r.json();
        })
        .then(data => {
          isLoading = false;
          hideSkeleton();
          allCards = (data || []).map(row => {
            const norm = {};
            Object.keys(row || {}).forEach(k => {
              norm[k.trim().toLowerCase()] = row[k] != null ? String(row[k]).trim() : '';
            });

            if ((norm['status paparan'] || '').toLowerCase() !== 'lulus') return null;
            if (!norm['nama']) return null;

            const companyRaw = norm['nama syarikat'] || norm['syarikat'] || '';
            const namaRaw = norm['nama'] || norm['nama penuh'] || '';
            const telefonRaw = norm['nombor telefon syarikat'] || norm['telefon'] || norm['telefon bimbit'] || '';
            const bidangRaw = norm['bidang'] || '';
            const subbidangRaw = norm['sub-bidang'] || norm['sub bidang'] || '';
            const butiranRaw = (norm['butiran perkhidmatan'] || norm['butiran'] || norm['butiran_perkhidmatan'] || '').trim();
            const picKadRaw = norm['pic kad'] || norm['kad'] || '';
            const kebenaranRaw = (norm['kebenaran untuk berkongsi maklumat jawatan'] || '').toLowerCase();
            const statusDalamSyarikatRaw = norm['status dalam syarikat'] || norm['jawatan'] || '';

            const company = escapeHTML(companyRaw);
            const nama = escapeHTML(namaRaw);
            const telefon = escapeHTML(telefonRaw);
            const bidang = escapeHTML(bidangRaw);
            const subbidang = escapeHTML(subbidangRaw);
            const butiran = escapeHTML(butiranRaw);
            const picKad = escapeHTML(picKadRaw);
            const statusJawatan = (kebenaranRaw === 'benarkan') ? escapeHTML(statusDalamSyarikatRaw || '-') : '-';

            const waText = encodeURIComponent(
              "ğŸ“Œ Kad Perkhidmatan Penduduk Banjaria Court\n\n" +
              "ğŸ‘¤ Nama: " + namaRaw + "\n" +
              (companyRaw ? "ğŸ¢ Syarikat: " + companyRaw + "\n" : "") +
              (telefonRaw ? "ğŸ“ Telefon: " + telefonRaw + "\n" : "") +
              "ğŸ“‹ Status: " + statusJawatan + "\n" +
              (bidangRaw ? "ğŸ“‚ Bidang: " + bidangRaw + "\n" : "") +
              (subbidangRaw ? "ğŸ“ Sub-bidang: " + subbidangRaw + "\n" : "") +
              (butiranRaw ? "ğŸ“ Butiran: " + butiranRaw + "\n" : "") +
              (picKadRaw ? "ğŸ“ Kad: " + picKadRaw : "")
            );

            const html = `
<article class="group bg-white border border-slate-100 rounded-xl p-4 shadow-sm flex flex-col gap-3 hover:shadow-card hover:-translate-y-0.5 transition">
  <div class="flex flex-col sm:flex-row gap-3 sm:items-start">
    <div class="flex-1 space-y-2">
      ${company ? `<div class=\"text-xl sm:text-2xl font-extrabold tracking-tight text-accent-strong uppercase leading-tight\">${company}</div>` : ''}
      <h3 class="text-sm sm:text-base font-semibold text-ink/90">${nama}</h3>

      <div class="space-y-1 text-sm text-slate-700">
        ${telefon ? `<div class="flex items-center gap-2"><span class="text-accent-strong">ğŸ“</span><span>${telefon}</span></div>` : ''}
        <div class="flex items-center gap-2"><span class="text-accent-strong">ğŸ“‹</span><span>${statusJawatan || '-'}</span></div>
        ${subbidang ? `<div class="flex items-center gap-2"><span class="text-accent-strong">ğŸ“</span><span>${subbidang}</span></div>` : ''}
      </div>

      <div class="text-sm text-slate-700 scrollbox">${butiran || '<span class="text-slate-400">Tiada butiran</span>'}</div>
    </div>

    <div class="sm:w-32 sm:shrink-0 flex sm:flex-col gap-2 sm:items-end">
      ${bidang ? `<span class="inline-flex items-center px-3 py-1.5 rounded-full bg-accent/20 text-xs font-semibold text-accent-strong border border-accent/30">${bidang}</span>` : ''}
    </div>
  </div>

  <div class="flex items-center gap-2 pt-2 border-t border-slate-100 mt-auto flex-wrap">
    ${picKad ? `<a href="${picKad}" target="_blank" class="px-3 py-2 bg-slate-50 text-ink rounded-md text-sm font-semibold flex items-center gap-2 border border-slate-200 hover:bg-slate-100">ğŸ“ Lihat Kad</a>` : ''}
    <a href="https://api.whatsapp.com/send?text=${waText}" target="_blank" class="ml-auto px-3 py-2 bg-accent text-ink rounded-md text-sm font-semibold flex items-center gap-2 hover:bg-accent-strong/90 hover:text-white">ğŸ“¤ WhatsApp</a>
  </div>
</article>
`.trim();

            return {
              bidang: bidangRaw || '',
              fields: {
                company: companyRaw,
                nama: namaRaw,
                telefon: telefonRaw,
                bidang: bidangRaw,
                subbidang: subbidangRaw,
                butiran: butiranRaw,
                picKad: picKadRaw,
                statusJawatan: statusJawatan
              },
              html
            };
          }).filter(Boolean);

          const sel = document.getElementById('bidangSelect');
          sel.innerHTML = '<option value="Semua">Semua</option>';
          bidangSet = new Set(allCards.map(c => c.bidang).filter(Boolean));
          [...bidangSet].sort().forEach(b => {
            const opt = document.createElement('option');
            opt.value = b; opt.textContent = b;
            sel.appendChild(opt);
          });

          populateChips();
          renderCards('Semua');
          initSearchIndex();
        })
        .catch(e => {
          isLoading = false;
          hideSkeleton();
          renderErrorState(e);
        });

      const shareBtn = document.getElementById('shareLink');
      const pageUrl = window.location.href;
      shareBtn.href = `https://api.whatsapp.com/send?text=${encodeURIComponent('Senarai Perkhidmatan Penduduk: ' + pageUrl)}`;
    });
  </script>
</body>
</html>
